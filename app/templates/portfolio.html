{% extends "base.html" %}

{% block title %}Portfolio â€” StockPulse{% endblock %}

{% block content %}
<div class="grid-sidebar">
  <div class="sidebar">
    <div class="sidebar-title">Portfolios</div>
    {% for p in portfolios %}
    <a href="/portfolio?portfolio_id={{ p.id }}"
       class="sidebar-item {{ 'active' if p.id == active_portfolio.id }}">
      {{ p.name }}
    </a>
    {% endfor %}
    <div class="sidebar-divider"></div>
    <div x-data="{ open: false }">
      <button type="button" class="btn btn-primary sidebar-new-action" @click="open = !open">+ New Portfolio</button>
      <form x-show="open" action="/api/portfolios" method="post" class="sidebar-inline-form">
        <input type="hidden" name="csrf_token" value="">
        <label class="visually-hidden" for="new-portfolio-name">Portfolio Name</label>
        <input id="new-portfolio-name" class="sp-input" name="name" placeholder="Portfolio name" required>
        <button type="submit" class="btn btn-primary sidebar-inline-create-btn">Create</button>
      </form>
    </div>
    <div class="sidebar-divider"></div>
    <div class="sidebar-title">Actions</div>
    <button type="button" class="btn btn-primary sidebar-action-btn" onclick="openModal('add-position-modal')">+ Add Position</button>
    <a class="sidebar-item"
       data-action="refresh"
       href="/portfolio?portfolio_id={{ active_portfolio.id }}&sort_by={{ sort_by }}&sort_dir={{ sort_dir }}&refresh=1">Refresh Prices</a>
  </div>

  <div>
    <div class="page-header-row">
      <h2 class="page-title">{{ active_portfolio.name }}</h2>
      <div class="text-muted page-refresh-meta">Last refreshed: {{ last_refreshed }}</div>
    </div>

    <div class="card">
      <div class="grid-4">
        <div class="stat">
          <div class="stat-value">${{ "{:,.0f}".format(stats.total_value) }}</div>
          <div class="stat-label">Total Value</div>
        </div>
        <div class="stat">
          <div class="stat-value {% if stats.total_pl >= 0 %}positive{% else %}negative{% endif %}">
            {{ "+" if stats.total_pl >= 0 }}${{ "{:,.0f}".format(stats.total_pl) }}
          </div>
          <div class="stat-label">Total P&L</div>
          <div class="stat-change {% if stats.total_pl_pct >= 0 %}positive{% else %}negative{% endif %}">
            {{ "+" if stats.total_pl_pct >= 0 }}{{ "{:.1f}".format(stats.total_pl_pct) }}%
          </div>
        </div>
        <div class="stat">
          <div class="stat-value {% if stats.day_pl >= 0 %}positive{% else %}negative{% endif %}">
            {{ "+" if stats.day_pl >= 0 }}${{ "{:,.0f}".format(stats.day_pl) }}
          </div>
          <div class="stat-label">Today</div>
          <div class="stat-change {% if stats.day_pl_pct >= 0 %}positive{% else %}negative{% endif %}">
            {{ "+" if stats.day_pl_pct >= 0 }}{{ "{:.1f}".format(stats.day_pl_pct) }}%
          </div>
        </div>
        <div class="stat">
          <div class="stat-value">${{ "{:,.0f}".format(stats.total_cost) }}</div>
          <div class="stat-label">Cost Basis</div>
        </div>
      </div>
    </div>

    <div class="grid-2">
      <div class="card">
        <div class="card-title">Sector Allocation</div>
        <div id="portfolio-sector-chart" class="portfolio-chart"></div>
      </div>
      <div class="card">
        <div class="card-title">Top Holdings</div>
        <div id="portfolio-positions-chart" class="portfolio-chart"></div>
      </div>
    </div>

    <div id="positions-table"
         hx-get="/hx/portfolio/table?portfolio_id={{ active_portfolio.id }}&sort_by={{ sort_by }}&sort_dir={{ sort_dir }}"
         hx-trigger="portfolioUpdated from:body"
         hx-swap="innerHTML">
      {% include "partials/portfolio_table.html" %}
    </div>
  </div>
</div>

<div id="add-position-modal" class="modal-overlay hidden" onclick="if(event.target===this) closeModal('add-position-modal')">
  <div class="modal">
    <h3>Add Position</h3>
    <form hx-post="/api/positions"
          hx-target="#positions-table"
          hx-swap="innerHTML"
          hx-on::after-request="closeModal('add-position-modal')">
      <input type="hidden" name="csrf_token" value="">
      <input type="hidden" name="portfolio_id" value="{{ active_portfolio.id }}">
      <input type="hidden" name="sort_by" value="{{ sort_by }}">
      <input type="hidden" name="sort_dir" value="{{ sort_dir }}">
      <div class="form-group">
        <label for="ticker">Ticker Symbol</label>
        <input class="sp-input" id="ticker" name="ticker" placeholder="e.g., AAPL" required>
      </div>
      <div class="form-group">
        <label for="shares">Number of Shares</label>
        <input class="sp-input" id="shares" name="shares" type="number" step="any" min="0.01" placeholder="e.g., 100" required>
      </div>
      <div class="form-group">
        <label for="avg_cost">Average Cost per Share ($)</label>
        <input class="sp-input" id="avg_cost" name="avg_cost" type="number" step="0.01" min="0" placeholder="e.g., 178.50" required>
      </div>
      <div class="form-group">
        <label for="date_acquired">Date Acquired (optional)</label>
        <input class="sp-input" id="date_acquired" name="date_acquired" type="date">
      </div>
      <div class="form-group">
        <label for="notes">Notes (optional)</label>
        <input class="sp-input" id="notes" name="notes" placeholder="e.g., Long-term hold">
      </div>
      <div class="form-actions">
        <button type="button" class="btn" onclick="closeModal('add-position-modal')">Cancel</button>
        <button type="submit" class="btn btn-primary">Add Position</button>
      </div>
    </form>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  async function loadPortfolioCharts(portfolioId) {
    const [sectorResp, positionsResp] = await Promise.all([
      fetch(`/api/chart/portfolio/${portfolioId}/sector`),
      fetch(`/api/chart/portfolio/${portfolioId}/positions`)
    ]);
    const sectorSpec = await sectorResp.json();
    const positionSpec = await positionsResp.json();
    Plotly.newPlot('portfolio-sector-chart', sectorSpec.data, sectorSpec.layout, { responsive: true, displayModeBar: false });
    Plotly.newPlot('portfolio-positions-chart', positionSpec.data, positionSpec.layout, { responsive: true, displayModeBar: false });
  }

  document.addEventListener('DOMContentLoaded', function () {
    loadPortfolioCharts({{ active_portfolio.id }});
  });

  document.body.addEventListener('htmx:afterSwap', function (evt) {
    if (evt.target && evt.target.id === 'positions-table') {
      loadPortfolioCharts({{ active_portfolio.id }});
    }
  });
</script>
{% endblock %}
