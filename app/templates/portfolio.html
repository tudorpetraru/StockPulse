{% extends "base.html" %}

{% block title %}Portfolio — StockPulse{% endblock %}

{% block content %}
<div class="grid-sidebar">
  <!-- Sidebar -->
  <div class="sidebar">
    <div class="sidebar-title">Portfolios</div>
    {% for p in portfolios %}
    <a href="/portfolio?portfolio_id={{ p.id }}"
       class="sidebar-item {{ 'active' if p.id == active_portfolio.id }}">
      {{ p.name }}
    </a>
    {% endfor %}
    <div class="sidebar-divider"></div>
    <div x-data="{ open: false }">
      <a class="sidebar-item" style="color:var(--blue); font-size:12px; cursor:pointer;" @click="open = !open">+ New Portfolio</a>
      <form x-show="open" action="/api/portfolios" method="post" style="padding:8px 12px;">
        <input type="hidden" name="csrf_token" value="">
        <input class="sp-input" name="name" placeholder="Portfolio name" required style="width:100%; margin-bottom:8px;">
        <button type="submit" class="btn btn-primary btn-sm" style="width:100%;">Create</button>
      </form>
    </div>
    <div class="sidebar-divider"></div>
    <div class="sidebar-title">Actions</div>
    <a class="sidebar-item" style="cursor:pointer;" onclick="openModal('add-position-modal')">+ Add Position</a>
    <a class="sidebar-item" style="cursor:pointer;" data-action="refresh">Refresh Prices</a>
  </div>

  <!-- Main Content -->
  <div>
    <h2 class="page-title">{{ active_portfolio.name }}</h2>

    <!-- Summary Stats -->
    <div class="card">
      <div class="grid-4">
        <div class="stat">
          <div class="stat-value">${{ "{:,.0f}".format(stats.total_value) }}</div>
          <div class="stat-label">Total Value</div>
        </div>
        <div class="stat">
          <div class="stat-value {% if stats.total_pl >= 0 %}positive{% else %}negative{% endif %}">
            {{ "+" if stats.total_pl >= 0 }}${{ "{:,.0f}".format(stats.total_pl) }}
          </div>
          <div class="stat-label">Total P&L</div>
          <div class="stat-change {% if stats.total_pl_pct >= 0 %}positive{% else %}negative{% endif %}">
            {{ "+" if stats.total_pl_pct >= 0 }}{{ "{:.1f}".format(stats.total_pl_pct) }}%
          </div>
        </div>
        <div class="stat">
          <div class="stat-value {% if stats.day_pl >= 0 %}positive{% else %}negative{% endif %}">
            {{ "+" if stats.day_pl >= 0 }}${{ "{:,.0f}".format(stats.day_pl) }}
          </div>
          <div class="stat-label">Today</div>
          <div class="stat-change {% if stats.day_pl_pct >= 0 %}positive{% else %}negative{% endif %}">
            {{ "+" if stats.day_pl_pct >= 0 }}{{ "{:.1f}".format(stats.day_pl_pct) }}%
          </div>
        </div>
        <div class="stat">
          <div class="stat-value">${{ "{:,.0f}".format(stats.total_cost) }}</div>
          <div class="stat-label">Cost Basis</div>
        </div>
      </div>
    </div>

    <!-- Allocation Charts -->
    <div class="grid-2">
      <div class="card">
        <div class="card-title">Sector Allocation</div>
        <div class="chart-placeholder" style="height:200px;">
          <div style="font-size:32px;">Sector Donut</div>
          <div style="font-size:12px;" class="text-muted">Plotly chart — populates after integration with DataService</div>
        </div>
      </div>
      <div class="card">
        <div class="card-title">Position Size</div>
        <div class="chart-placeholder" style="height:200px;">
          <div style="font-size:32px;">Position Bars</div>
          <div style="font-size:12px;" class="text-muted">Plotly chart — populates after integration with DataService</div>
        </div>
      </div>
    </div>

    <!-- Positions Table -->
    <div id="positions-table"
         hx-get="/hx/portfolio/table?portfolio_id={{ active_portfolio.id }}"
         hx-trigger="portfolioUpdated from:body"
         hx-swap="innerHTML">
      {% include "partials/portfolio_table.html" %}
    </div>
  </div>
</div>

<!-- Add Position Modal -->
<div id="add-position-modal" class="modal-overlay hidden" onclick="if(event.target===this) closeModal('add-position-modal')">
  <div class="modal">
    <h3>Add Position</h3>
    <form hx-post="/api/positions"
          hx-target="#positions-table"
          hx-swap="innerHTML"
          hx-on::after-request="closeModal('add-position-modal')">
      <input type="hidden" name="csrf_token" value="">
      <input type="hidden" name="portfolio_id" value="{{ active_portfolio.id }}">
      <div class="form-group">
        <label for="ticker">Ticker Symbol</label>
        <input class="sp-input" id="ticker" name="ticker" placeholder="e.g., AAPL" required>
      </div>
      <div class="form-group">
        <label for="shares">Number of Shares</label>
        <input class="sp-input" id="shares" name="shares" type="number" step="any" min="0.01" placeholder="e.g., 100" required>
      </div>
      <div class="form-group">
        <label for="avg_cost">Average Cost per Share ($)</label>
        <input class="sp-input" id="avg_cost" name="avg_cost" type="number" step="0.01" min="0" placeholder="e.g., 178.50" required>
      </div>
      <div class="form-group">
        <label for="date_acquired">Date Acquired (optional)</label>
        <input class="sp-input" id="date_acquired" name="date_acquired" type="date">
      </div>
      <div class="form-group">
        <label for="notes">Notes (optional)</label>
        <input class="sp-input" id="notes" name="notes" placeholder="e.g., Long-term hold">
      </div>
      <div class="form-actions">
        <button type="button" class="btn" onclick="closeModal('add-position-modal')">Cancel</button>
        <button type="submit" class="btn btn-primary">Add Position</button>
      </div>
    </form>
  </div>
</div>
{% endblock %}
