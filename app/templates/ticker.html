{% extends "base.html" %}
{% block title %}{{ profile.name }} ({{ symbol }}) — StockPulse{% endblock %}

{% block content %}
<!-- ── Company Header Card ──────────────────────────────────────────── -->
<div class="card">
  <div class="company-header">
    <div>
      <div class="company-name">
        {{ profile.name }}
        <span class="company-symbol">{{ symbol }}</span>
      </div>
      <div class="company-sub">
        {{ profile.sector }} · {{ profile.industry }} · {{ profile.exchange }}
        · Last updated {{ price.updated }}
      </div>
      <div class="company-actions">
        <button class="btn btn-sm btn-primary"
                data-action="add-watchlist"
                hx-post="/api/watchlist/add"
                hx-vals='{"symbol":"{{ symbol }}"}'
                hx-swap="none">+ Add to Watchlist</button>
        <a class="btn btn-sm" href="/portfolio">Add Position</a>
        <button class="btn btn-sm"
                data-action="refresh"
                hx-get="/ticker/{{ symbol }}"
                hx-target="body"
                hx-push-url="true">Refresh ↻</button>
      </div>
    </div>
    <div class="company-price">
      <div class="price">${{ "%.2f"|format(price.price) }}</div>
      <div class="change {% if price.change >= 0 %}positive{% else %}negative{% endif %}">
        {% if price.change >= 0 %}+{% endif %}${{ "%.2f"|format(price.change) }}
        ({% if price.change_pct >= 0 %}+{% endif %}{{ "%.1f"|format(price.change_pct) }}%) today
      </div>
    </div>
  </div>

  <!-- ── Key Metrics Grid (6×2) ─────────────────────────────────────── -->
  <div class="metrics-grid">
    {% set metric_items = [
      ("P/E", metrics.pe), ("Fwd P/E", metrics.fwd_pe), ("PEG", metrics.peg),
      ("Mkt Cap", metrics.mkt_cap), ("EV/EBITDA", metrics.ev_ebitda), ("Beta", metrics.beta),
      ("P/S", metrics.ps), ("P/B", metrics.pb), ("ROE", metrics.roe),
      ("Profit Margin", metrics.profit_margin), ("Debt/Equity", metrics.debt_equity),
      ("Insider Own", metrics.insider_own),
    ] %}
    {% for label, value in metric_items %}
    <div class="metric">
      <div class="metric-label">{{ label }}</div>
      <div class="metric-value">{{ value }}</div>
    </div>
    {% endfor %}
  </div>
</div>

<!-- ── Tab Bar ──────────────────────────────────────────────────────── -->
<div class="ticker-tabs">
  <div class="wf-tabs" role="tablist" aria-label="Ticker sections">
    <a class="wf-tab sp-tab active" data-tab="overview" href="/ticker/{{ symbol }}">Overview</a>
    <button type="button" class="wf-tab sp-tab" data-tab="financials"
         hx-get="/hx/ticker/{{ symbol }}/financials"
         hx-target="#tab-content"
         hx-swap="innerHTML">Financials</button>
    <button type="button" class="wf-tab sp-tab" data-tab="news"
         hx-get="/hx/ticker/{{ symbol }}/news"
         hx-target="#tab-content"
         hx-swap="innerHTML">News</button>
    <button type="button" class="wf-tab sp-tab" data-tab="insiders"
         hx-get="/hx/ticker/{{ symbol }}/insiders"
         hx-target="#tab-content"
         hx-swap="innerHTML">Insiders</button>
    <button type="button" class="wf-tab sp-tab" data-tab="holders"
         hx-get="/hx/ticker/{{ symbol }}/holders"
         hx-target="#tab-content"
         hx-swap="innerHTML">Holders</button>
    <button type="button" class="wf-tab sp-tab" data-tab="earnings"
         hx-get="/hx/ticker/{{ symbol }}/earnings"
         hx-target="#tab-content"
         hx-swap="innerHTML">Earnings</button>
    <button type="button" class="wf-tab sp-tab" data-tab="predictions"
         hx-get="/hx/ticker/{{ symbol }}/predictions"
         hx-target="#tab-content"
         hx-swap="innerHTML">Predictions</button>
  </div>

  <!-- ── Tab Content ─────────────────────────────────────────────────── -->
  <div id="tab-content">
    <!-- Overview (eager) -->
    <div class="grid-2">
      <!-- Price Chart -->
      <div class="card">
        <div class="card-title">Price History</div>
        <div class="period-selector" id="price-period-selector">
          {% for p in ['1M','3M','6M','1Y','5Y'] %}
          <button type="button"
                  class="period-btn {% if p == '1Y' %}active{% endif %}"
                  data-price-period="{{ p }}"
                  onclick="loadPriceChart('{{ symbol }}', '{{ p }}', this)">{{ p }}</button>
          {% endfor %}
        </div>
        <div id="price-chart" class="ticker-price-chart"></div>
      </div>

      <!-- Analyst Consensus -->
      <div class="card">
        <div class="card-title">Analyst Consensus</div>
        <div class="analyst-consensus-header">
          <div class="consensus-rating {% if analysts.consensus in ['Strong Buy','Buy'] %}positive{% elif analysts.consensus in ['Sell','Strong Sell'] %}negative{% endif %}">
            {{ analysts.consensus }}
          </div>
          <div class="consensus-meta">Based on {{ analysts.count }} analysts</div>
        </div>
        <div class="target-prices">
            <div class="target">
            <div class="target-value negative">{% if analysts.low != "N/A" %}${{ analysts.low }}{% else %}N/A{% endif %}</div>
            <div class="target-label">Low Target</div>
          </div>
          <div class="target">
            <div class="target-value">{% if analysts.avg != "N/A" %}${{ analysts.avg }}{% else %}N/A{% endif %}</div>
            <div class="target-label">Avg Target</div>
          </div>
          <div class="target">
            <div class="target-value positive">{% if analysts.high != "N/A" %}${{ analysts.high }}{% else %}N/A{% endif %}</div>
            <div class="target-label">High Target</div>
          </div>
        </div>
        {% if analysts.ratings %}
        <table class="wf-table compact-table">
          <thead><tr><th>Date</th><th>Analyst</th><th>Action</th><th>Rating</th><th>Target</th></tr></thead>
          <tbody>
          {% for r in analysts.ratings[:5] %}
            <tr>
              <td>{{ r.date }}</td>
              <td>{{ r.firm }}</td>
              <td>{{ r.action }}</td>
              <td><span class="badge badge-{{ 'buy' if r.rating in ['Buy','Strong Buy','Overweight'] else ('sell' if r.rating in ['Sell','Strong Sell','Underweight'] else 'hold') }}">{{ r.rating }}</span></td>
              <td>{% if r.target != "N/A" %}${{ r.target }}{% else %}N/A{% endif %}</td>
            </tr>
          {% endfor %}
          </tbody>
        </table>
        {% endif %}
      </div>
    </div>

    <!-- Comparable Companies -->
    {% if peers %}
    <div class="card">
      <div class="card-title">Comparable Companies</div>
      <table class="wf-table">
        <thead><tr><th>Ticker</th><th>Company</th><th>Price</th><th>P/E</th><th>Mkt Cap</th><th>YTD</th></tr></thead>
        <tbody>
        {% for p in peers %}
          <tr>
            <td class="ticker"><a href="/ticker/{{ p.symbol }}">{{ p.symbol }}</a></td>
            <td>{{ p.name }}</td>
            <td>${{ "%.2f"|format(p.price) }}</td>
            <td>{{ p.pe }}</td>
            <td>{{ p.mkt_cap }}</td>
            {% set ytd_value = p.ytd if p.ytd is not none else 0 %}
            <td class="{% if ytd_value > 0.05 %}positive{% elif ytd_value < -0.05 %}negative{% else %}text-muted{% endif %}">
              {% if ytd_value > 0.05 %}+{{ "%.1f"|format(ytd_value) }}%{% elif ytd_value < -0.05 %}{{ "%.1f"|format(ytd_value) }}%{% else %}0.0%{% endif %}
            </td>
          </tr>
        {% endfor %}
        </tbody>
      </table>
    </div>
    {% endif %}
  </div>
</div>

<!-- ── Plotly chart loader ──────────────────────────────────────────── -->
<script>
async function loadPriceChart(symbol, period, periodButton) {
  if (periodButton) {
    document.querySelectorAll('[data-price-period]').forEach((btn) => {
      btn.classList.toggle('active', btn === periodButton);
    });
  }
  const resp = await fetch(`/api/chart/${symbol}/price?period=${period}`);
  const spec = await resp.json();
  Plotly.newPlot('price-chart', spec.data, spec.layout, {responsive: true, displayModeBar: false});
}
// Load default chart on page load
document.addEventListener('DOMContentLoaded', () => loadPriceChart('{{ symbol }}', '1Y'));
</script>
{% endblock %}
