<!-- Predictions tab partial -->
{% if status == "error" %}
<div class="alert alert-error">‚ùå Prediction data temporarily unavailable. <a
        hx-get="/hx/ticker/{{ symbol }}/predictions" hx-target="#tab-content" hx-swap="innerHTML">Click to retry.</a>
</div>
{% else %}

<!-- Summary Stats -->
<div class="card">
    <div class="card-title">Prediction Tracking Summary ‚Äî {{ symbol }}</div>
    <div class="grid-4">
        <div class="stat">
            <div class="stat-value">{{ summary.active }}</div>
            <div class="stat-label">Active Predictions</div>
        </div>
        <div class="stat">
            <div class="stat-value" {% if cold_start %}style="color:var(--gray-400);" {% endif %}>
                {{ summary.resolved if summary.resolved else "0" }}
            </div>
            <div class="stat-label">Resolved</div>
        </div>
        <div class="stat">
            <div class="stat-value {% if summary.accuracy and summary.accuracy >= 60 %}positive{% elif summary.accuracy and summary.accuracy < 40 %}negative{% endif %}"
                {% if cold_start %}style="color:var(--gray-400);" {% endif %}>
                {% if summary.accuracy is not none %}{{ "%.0f"|format(summary.accuracy) }}%{% else %}‚Äî{% endif %}
            </div>
            <div class="stat-label">Consensus Accuracy{% if cold_start %} (pending){% endif %}</div>
        </div>
        <div class="stat">
            <div class="stat-value">{{ summary.consensus_target }}</div>
            <div class="stat-label">Current Consensus Target</div>
        </div>
    </div>
</div>

<!-- Cold Start Message -->
{% if cold_start %}
<div class="cold-start">
    <h3>üìä Building Your Prediction Database</h3>
    <p>StockPulse is collecting analyst predictions for <strong>{{ symbol }}</strong>.</p>
    <p class="cold-start-detail">Accuracy scores require 12 months of data. First results will appear approximately 12
        months after initial data collection. Automatic snapshot collection runs <strong>{{ prediction_schedule_text
            }}</strong>. When this page has no captured records yet, StockPulse will automatically trigger one on-load
        capture for this symbol. In the meantime, you can see how analyst targets evolve over time in the chart below.
    </p>
    <p id="prediction-snapshot-status" class="cold-start-status"></p>
</div>
{% endif %}

<!-- Consensus Timeline Chart -->
<div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
        <div class="card-title" style="margin-bottom:0;">Consensus Target vs Actual Price</div>
        <div class="period-selector" id="consensus-period-selector" style="margin-bottom:0;">
            <button type="button" class="period-btn" data-consensus-period="1Y" onclick="loadConsensusChart('{{ symbol }}', '1Y', this)">1Y</button>
            <button type="button" class="period-btn active" data-consensus-period="2Y" onclick="loadConsensusChart('{{ symbol }}', '2Y', this)">2Y</button>
            <button type="button" class="period-btn" data-consensus-period="All" onclick="loadConsensusChart('{{ symbol }}', 'All', this)">All</button>
        </div>
    </div>
    <div id="consensus-chart" style="height:300px;"></div>
    {% if cold_start %}
    <div style="font-size:12px;color:var(--gray-500);margin-top:8px;text-align:center;">
        Chart will populate as daily snapshots accumulate. Accuracy markers appear after predictions resolve (12
        months).
    </div>
    {% endif %}
</div>

<!-- Analyst Scorecard -->
{% if scorecard %}
<div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
        <div class="card-title" style="margin-bottom:0;">Analyst Scorecard ‚Äî {{ symbol }} Coverage</div>
        <div style="display:flex;align-items:center;gap:8px;">
            <span style="font-size:12px;color:var(--gray-500);">Sorted by Composite Score ‚Üì</span>
            <button type="button" class="btn btn-sm" onclick="exportPredictionsTableCsv('scorecard-table', '{{ symbol }}-analyst-scorecard.csv')">Export CSV</button>
        </div>
    </div>
    <table id="scorecard-table" class="wf-table">
        <thead>
            <tr>
                <th>Rank</th>
                <th>Firm</th>
                <th>Predictions</th>
                <th>Success Rate ‚Üï</th>
                <th>Direction ‚Üï</th>
                <th>Avg Error ‚Üï</th>
                <th>Score ‚Üï</th>
                <th>Latest</th>
                <th>Target</th>
            </tr>
        </thead>
        <tbody>
            {% for a in scorecard %}
            <tr>
                <td>
                    <span
                        class="leaderboard-rank {% if loop.index == 1 %}rank-gold{% elif loop.index == 2 %}rank-silver{% elif loop.index == 3 %}rank-bronze{% else %}rank-normal{% endif %}">
                        {% if a.insufficient %}‚Äî{% else %}{{ loop.index }}{% endif %}
                    </span>
                </td>
                <td style="font-weight:600;">{{ a.firm }}</td>
                <td>{{ a.total_predictions }}</td>
                {% if a.insufficient %}
                <td colspan="4" style="color:var(--gray-500);font-style:italic;">Insufficient data (min 5 predictions
                    required)</td>
                {% else %}
                <td>
                    <span
                        class="score-bar {% if a.success_rate >= 60 %}score-high{% elif a.success_rate >= 40 %}score-mid{% else %}score-low{% endif %}">
                        <span class="score-bar-fill" style="width:{{ a.success_rate }}%"></span>
                    </span>
                    <span
                        class="{% if a.success_rate >= 60 %}positive{% elif a.success_rate < 40 %}negative{% endif %}">{{
                        "%.0f"|format(a.success_rate) }}%</span>
                </td>
                <td class="{% if a.direction_rate >= 70 %}positive{% elif a.direction_rate < 50 %}negative{% endif %}">
                    {{ "%.0f"|format(a.direction_rate) }}%</td>
                <td>{{ "%.1f"|format(a.avg_error) }}%</td>
                <td><span
                        class="badge {% if a.composite >= 70 %}badge-green{% elif a.composite >= 50 %}badge-amber{% else %}badge-red{% endif %}">{{
                        "%.0f"|format(a.composite) }}</span></td>
                {% endif %}
                <td><span
                        class="badge {% if a.latest_rating in ['Buy','Strong Buy','Overweight'] %}badge-green{% elif a.latest_rating in ['Sell','Strong Sell','Underweight'] %}badge-red{% else %}badge-amber{% endif %}">{{
                        a.latest_rating }}</span></td>
                <td>{% if a.latest_target != "N/A" %}${{ a.latest_target }}{% else %}N/A{% endif %}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endif %}

<div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
        <div class="card-title" style="margin-bottom:0;">Captured Prediction Records</div>
        <div style="display:flex;align-items:center;gap:8px;">
            <span style="font-size:12px;color:var(--gray-500);">Showing latest {{ predictions|length if predictions else 0
                }} entries</span>
            <button type="button" class="btn btn-sm" onclick="exportPredictionsTableCsv('captured-predictions-table', '{{ symbol }}-captured-predictions.csv')">Export CSV</button>
        </div>
    </div>
    <div style="font-size:12px;color:var(--gray-500);margin-bottom:12px;">
        Stored analyst snapshot fields for {{ symbol }} (date, firm, target, returns, resolution, source).
    </div>
    <div style="overflow-x:auto;">
        <table id="captured-predictions-table" class="wf-table">
            <thead>
                <tr>
                    <th>Snapshot Date</th>
                    <th>Firm</th>
                    <th>Action</th>
                    <th>Rating</th>
                    <th>Target</th>
                    <th>Implied Return</th>
                    <th>Resolve Date</th>
                    <th>Status</th>
                    <th>Source</th>
                </tr>
            </thead>
            <tbody>
                {% if predictions %}
                {% for p in predictions[:25] %}
                <tr>
                    <td>{{ p.snapshot_date }}</td>
                    <td>{{ p.firm }}</td>
                    <td>{{ p.action }}</td>
                    <td>{{ p.rating }}</td>
                    <td>{% if p.target != "N/A" %}${{ p.target }}{% else %}N/A{% endif %}</td>
                    <td>{{ p.implied_return }}</td>
                    <td>{{ p.resolve_date }}</td>
                    <td>
                        {% if p.resolved %}
                        {% if p.accurate %}
                        <span class="badge badge-green">Resolved ‚úì</span>
                        {% else %}
                        <span class="badge badge-red">Resolved ‚úó</span>
                        {% endif %}
                        {% else %}
                        <span class="badge badge-blue">Pending</span>
                        {% endif %}
                    </td>
                    <td>{{ p.source }}</td>
                </tr>
                {% endfor %}
                {% else %}
                <tr>
                    <td colspan="9" style="color:var(--gray-500);font-style:italic;">No prediction snapshots captured
                        yet for {{ symbol }}.</td>
                </tr>
                {% endif %}
            </tbody>
        </table>
    </div>
</div>

<script>
    async function loadConsensusChart(symbol, period, periodButton) {
        if (periodButton) {
            document.querySelectorAll('[data-consensus-period]').forEach((btn) => {
                btn.classList.toggle('active', btn === periodButton);
            });
        }
        const resp = await fetch(`/api/chart/${symbol}/consensus?period=${period}`);
        const spec = await resp.json();
        Plotly.newPlot('consensus-chart', spec.data, spec.layout, { responsive: true, displayModeBar: false });
    }

    function exportPredictionsTableCsv(tableId, filename) {
        const table = document.getElementById(tableId);
        if (!table) return;
        const rows = Array.from(table.querySelectorAll('tr'));
        const toCell = (value) => {
            const text = String(value ?? '').replace(/\s+/g, ' ').trim();
            return `"${text.replace(/"/g, '""')}"`;
        };

        const csvLines = rows.map((row) => {
            const cells = Array.from(row.querySelectorAll('th, td'));
            return cells.map((cell) => toCell(cell.textContent || '')).join(',');
        });

        const csv = '\uFEFF' + csvLines.join('\n');
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = filename;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(link.href);
    }

    function updatePredictionSnapshotStatus(message, tone) {
        const el = document.getElementById('prediction-snapshot-status');
        if (!el) return;
        el.textContent = message || '';
        if (tone === 'success') {
            el.style.color = 'var(--positive)';
            return;
        }
        if (tone === 'error') {
            el.style.color = 'var(--negative)';
            return;
        }
        el.style.color = 'var(--gray-600)';
    }

    async function maybeTriggerInitialPredictionSnapshot(symbol) {
        const storageKey = `prediction-autosnapshot:${symbol}:${new Date().toISOString().slice(0, 10)}`;
        try {
            if (window.sessionStorage.getItem(storageKey)) {
                return;
            }
            window.sessionStorage.setItem(storageKey, '1');
        } catch (_) {
            // Session storage can be unavailable in private browsing modes.
        }

        updatePredictionSnapshotStatus('No prediction records yet. Triggering an initial snapshot capture...');
        const token = typeof getCsrfToken === 'function' ? getCsrfToken() : '';
        try {
            const resp = await fetch(`/api/predictions/${symbol}/snapshot/run`, {
                method: 'POST',
                headers: {
                    'x-csrf-token': token,
                },
            });
            const payload = await resp.json().catch(() => ({}));
            if (!resp.ok || payload.status !== 'ok') {
                if (resp.status === 429) {
                    updatePredictionSnapshotStatus('Snapshot trigger is rate-limited. Try again in about a minute.', 'error');
                } else {
                    updatePredictionSnapshotStatus('Automatic snapshot trigger failed. It will retry on the scheduled run.', 'error');
                }
                return;
            }

            const created = Number(payload.snapshots_created || 0);
            updatePredictionSnapshotStatus(`Snapshot run finished (${created} record set${created === 1 ? '' : 's'} updated). Refreshing...`, 'success');
            if (window.htmx) {
                window.htmx.ajax('GET', `/hx/ticker/${symbol}/predictions`, { target: '#tab-content', swap: 'innerHTML' });
            }
        } catch (_) {
            updatePredictionSnapshotStatus('Automatic snapshot trigger failed. It will retry on the scheduled run.', 'error');
        }
    }

    loadConsensusChart('{{ symbol }}', '2Y');
    {% if auto_snapshot_on_load %}
    maybeTriggerInitialPredictionSnapshot('{{ symbol }}');
    {% endif %}
</script>
{% endif %}
