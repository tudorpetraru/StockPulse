{% extends "base.html" %}

{% block title %}Dashboard — StockPulse{% endblock %}

{% block content %}
<!-- Portfolio Summary Card -->
<div class="card">
  <div class="card-title">Portfolio Summary{% if portfolio.name %} — {{ portfolio.name }}{% endif %}</div>
  <div class="grid-4">
    <div class="stat">
      <div class="stat-value">${{ "{:,.0f}".format(portfolio.total_value) }}</div>
      <div class="stat-label">Total Value</div>
    </div>
    <div class="stat">
      <div class="stat-value {% if portfolio.day_pl >= 0 %}positive{% else %}negative{% endif %}">
        {{ "+" if portfolio.day_pl >= 0 }}${{ "{:,.0f}".format(portfolio.day_pl) }}
      </div>
      <div class="stat-label">Today's P&L</div>
      <div class="stat-change {% if portfolio.day_pl_pct >= 0 %}positive{% else %}negative{% endif %}">
        {{ "+" if portfolio.day_pl_pct >= 0 }}{{ "{:.1f}".format(portfolio.day_pl_pct) }}%
      </div>
    </div>
    <div class="stat">
      <div class="stat-value {% if portfolio.total_pl >= 0 %}positive{% else %}negative{% endif %}">
        {{ "+" if portfolio.total_pl >= 0 }}${{ "{:,.0f}".format(portfolio.total_pl) }}
      </div>
      <div class="stat-label">Total P&L</div>
      <div class="stat-change {% if portfolio.total_pl_pct >= 0 %}positive{% else %}negative{% endif %}">
        {{ "+" if portfolio.total_pl_pct >= 0 }}{{ "{:.1f}".format(portfolio.total_pl_pct) }}%
      </div>
    </div>
    <div class="stat">
      <div class="stat-value">{{ portfolio.position_count }}</div>
      <div class="stat-label">Positions</div>
    </div>
  </div>
</div>

<div class="grid-2">
  <!-- Watchlist Movers -->
  <div class="card">
    <div class="card-title">Watchlist Movers</div>
    {% if movers %}
    <table class="sp-table">
      <thead>
        <tr><th>Ticker</th><th>Price</th><th>Change</th></tr>
      </thead>
      <tbody>
        {% for m in movers %}
        <tr>
          <td><a href="/ticker/{{ m.ticker }}" class="ticker-link">{{ m.ticker }}</a></td>
          <td>${{ "{:.2f}".format(m.price) }}</td>
          <td class="{% if m.change_pct >= 0 %}positive{% else %}negative{% endif %}">
            {{ "+" if m.change_pct >= 0 }}{{ "{:.1f}".format(m.change_pct) }}%
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    {% else %}
    <p class="text-muted" style="font-size:13px;">Add tickers to your watchlist to see movers here.</p>
    {% endif %}
  </div>

  <!-- Recent News -->
  <div class="card">
    <div class="card-title">Recent News</div>
    {% if news %}
    {% for item in news[:5] %}
    <div class="news-item">
      <div class="news-title">
        <a href="{{ item.url }}" target="_blank" rel="noopener">{{ item.title }}</a>
      </div>
      <div class="news-meta">
        <span class="source">{{ item.source }}</span>
        · {{ item.published }}
        {% if item.ticker %}
        · <a href="/ticker/{{ item.ticker }}" class="ticker-link">{{ item.ticker }}</a>
        {% endif %}
      </div>
    </div>
    {% endfor %}
    {% else %}
    <p class="text-muted" style="font-size:13px;">No recent news. Add portfolio positions or watchlist tickers to see relevant news.</p>
    {% endif %}
  </div>
</div>

<!-- Market Snapshot -->
<div class="card">
  <div class="card-title">Market Snapshot</div>
  <div class="grid-3">
    {% for idx in market %}
    <div style="display:flex; justify-content:space-between; align-items:center; padding:8px 0;">
      <div>
        <div style="font-weight:600; font-size:14px;">{{ idx.name }}</div>
        <div style="font-size:12px;" class="text-muted">
          {% if idx.value is not none %}{{ "{:,.2f}".format(idx.value) }}{% else %}N/A{% endif %}
        </div>
      </div>
      <div style="text-align:right;">
        <div class="{% if idx.change_pct >= 0 %}positive{% else %}negative{% endif %}" style="font-size:14px; font-weight:600;">
          {% if idx.change_pct is not none %}
          {% set pct = idx.change_pct %}
          {% if pct > 0.005 %}+{{ "{:.2f}".format(pct) }}%{% elif pct < -0.005 %}{{ "{:.2f}".format(pct) }}%{% else %}0.00%{% endif %}
          {% else %}N/A{% endif %}
        </div>
      </div>
    </div>
    {% endfor %}
  </div>
</div>

<!-- Prediction Tracker Widget -->
<div class="card" style="border:2px solid var(--blue-light);">
  <div class="card-title" style="display:flex; justify-content:space-between; align-items:center;">
    <span>Prediction Tracker</span>
    <a href="/analysts" class="btn-ghost" style="font-size:11px; text-transform:none; letter-spacing:0;">View Leaderboard →</a>
  </div>

  <div class="grid-3" style="margin-bottom:var(--space-lg);">
    <div style="text-align:center;">
      <div style="font-size:24px; font-weight:700; color:var(--blue);">{{ predictions.tracking }}</div>
      <div style="font-size:11px;" class="text-muted">Tracking</div>
    </div>
    <div style="text-align:center;">
      <div style="font-size:24px; font-weight:700; color:var(--positive);">{{ predictions.resolved_month }}</div>
      <div style="font-size:11px;" class="text-muted">Resolved This Month</div>
    </div>
    <div style="text-align:center;">
      <div style="font-size:24px; font-weight:700; color:var(--positive);">
        {% if predictions.monthly_accuracy is not none %}{{ "{:.0f}".format(predictions.monthly_accuracy) }}%{% else %}N/A{% endif %}
      </div>
      <div style="font-size:11px;" class="text-muted">Monthly Accuracy</div>
    </div>
  </div>

  {% if predictions.top_analysts %}
  <div style="font-size:12px; font-weight:600; text-transform:uppercase; letter-spacing:0.5px; margin-bottom:8px;" class="text-muted">Top Analysts This Month</div>
  <div style="display:flex; flex-direction:column; gap:6px;">
    {% for a in predictions.top_analysts[:3] %}
    <div style="display:flex; align-items:center; gap:10px; padding:6px 8px; background:var(--bg-subtle); border-radius:var(--radius-sm);">
      <span class="rank {% if loop.index == 1 %}rank-gold{% elif loop.index == 2 %}rank-silver{% elif loop.index == 3 %}rank-bronze{% else %}rank-default{% endif %}" style="width:22px; height:22px; font-size:11px;">{{ loop.index }}</span>
      <span style="font-size:13px; font-weight:600; flex:1;">{{ a.firm }}</span>
      <span class="badge badge-green" style="font-size:10px;">Score: {{ a.score }}</span>
    </div>
    {% endfor %}
  </div>
  {% else %}
  <p class="text-muted" style="font-size:12px;">Prediction tracking data will appear here as snapshots accumulate.</p>
  {% endif %}
</div>
{% endblock %}
